<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>compect_csv.py - Group all processors with identical mappings together &mdash; Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 4-Jun-2013 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '4-Jun-2013',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 4-Jun-2013 documentation" href="../index.html" />
    <link rel="up" title="Utilities" href="../utilities.html" />
    <link rel="next" title="dataXfer_test.c - Runs unit tests on PIC data transfor protocol" href="../util/dataXfer_test.c.html" />
    <link rel="prev" title="data_sheet_to_csv.py - GUI to assist in translating Microchip data sheets to pin mappings" href="data_sheet_to_csv.py.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../util/dataXfer_test.c.html" title="dataXfer_test.c - Runs unit tests on PIC data transfor protocol"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="data_sheet_to_csv.py.html" title="data_sheet_to_csv.py - GUI to assist in translating Microchip data sheets to pin mappings"
             accesskey="P">previous</a> |</li>
        <li><a href="../contents.html">Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 4-Jun-2013 documentation</a> &raquo;</li>
          <li><a href="../utilities.html" accesskey="U">Utilities</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="compect-csv-py-group-all-processors-with-identical-mappings-together">
<h1>compect_csv.py - Group all processors with identical mappings together<a class="headerlink" href="#compect-csv-py-group-all-processors-with-identical-mappings-together" title="Permalink to this headline">¶</a></h1>
<div class="highlight-c"><div class="highlight"><pre>

</pre></div>
</div>
<div class="section" id="from-https-gist-github-com-samuraisam-901117">
<h2>From <a class="reference external" href="https://gist.github.com/samuraisam/901117">https://gist.github.com/samuraisam/901117</a><a class="headerlink" href="#from-https-gist-github-com-samuraisam-901117" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c"><div class="highlight"><pre>
import datetime, time, functools, operator, types

default_fudge = datetime.timedelta(seconds=0, microseconds=0, days=0)

def deep_eq(_v1, _v2, datetime_fudge=default_fudge, _assert=False):
  &quot;&quot;&quot;
  Tests for deep equality between two python data structures recursing
  into sub-structures if necessary. Works with all python types including
  iterators and generators. This function was dreampt up to test API responses
  but could be used for anything. Be careful. With deeply nested structures
  you may blow the stack.

  Options:
            datetime_fudge =&gt; this is a datetime.timedelta object which, when
                              comparing dates, will accept values that differ
                              by the number of seconds specified
            _assert        =&gt; passing yes for this will raise an assertion error
                              when values do not match, instead of returning
                              false (very useful in combination with pdb)

  Doctests included:

  &gt;&gt;&gt; x1, y1 = ({&#39;a&#39;: &#39;b&#39;}, {&#39;a&#39;: &#39;b&#39;})
  &gt;&gt;&gt; deep_eq(x1, y1)
  True
  &gt;&gt;&gt; x2, y2 = ({&#39;a&#39;: &#39;b&#39;}, {&#39;b&#39;: &#39;a&#39;})
  &gt;&gt;&gt; deep_eq(x2, y2)
  False
  &gt;&gt;&gt; x3, y3 = ({&#39;a&#39;: {&#39;b&#39;: &#39;c&#39;}}, {&#39;a&#39;: {&#39;b&#39;: &#39;c&#39;}})
  &gt;&gt;&gt; deep_eq(x3, y3)
  True
  &gt;&gt;&gt; x4, y4 = ({&#39;c&#39;: &#39;t&#39;, &#39;a&#39;: {&#39;b&#39;: &#39;c&#39;}}, {&#39;a&#39;: {&#39;b&#39;: &#39;n&#39;}, &#39;c&#39;: &#39;t&#39;})
  &gt;&gt;&gt; deep_eq(x4, y4)
  False
  &gt;&gt;&gt; x5, y5 = ({&#39;a&#39;: [1,2,3]}, {&#39;a&#39;: [1,2,3]})
  &gt;&gt;&gt; deep_eq(x5, y5)
  True
  &gt;&gt;&gt; x6, y6 = ({&#39;a&#39;: [1,&#39;b&#39;,8]}, {&#39;a&#39;: [2,&#39;b&#39;,8]})
  &gt;&gt;&gt; deep_eq(x6, y6)
  False
  &gt;&gt;&gt; x7, y7 = (&#39;a&#39;, &#39;a&#39;)
  &gt;&gt;&gt; deep_eq(x7, y7)
  True
  &gt;&gt;&gt; x8, y8 = ([&#39;p&#39;,&#39;n&#39;,[&#39;asdf&#39;]], [&#39;p&#39;,&#39;n&#39;,[&#39;asdf&#39;]])
  &gt;&gt;&gt; deep_eq(x8, y8)
  True
  &gt;&gt;&gt; x9, y9 = ([&#39;p&#39;,&#39;n&#39;,[&#39;asdf&#39;,[&#39;omg&#39;]]], [&#39;p&#39;, &#39;n&#39;, [&#39;asdf&#39;,[&#39;nowai&#39;]]])
  &gt;&gt;&gt; deep_eq(x9, y9)
  False
  &gt;&gt;&gt; x10, y10 = (1, 2)
  &gt;&gt;&gt; deep_eq(x10, y10)
  False
  &gt;&gt;&gt; deep_eq((str(p) for p in xrange(10)), (str(p) for p in xrange(10)))
  True
  &gt;&gt;&gt; str(deep_eq(range(4), range(4)))
  &#39;True&#39;
  &gt;&gt;&gt; deep_eq(xrange(100), xrange(100))
  True
  &gt;&gt;&gt; deep_eq(xrange(2), xrange(5))
  False
  &gt;&gt;&gt; import datetime
  &gt;&gt;&gt; from datetime import datetime as dt
  &gt;&gt;&gt; d1, d2 = (dt.now(), dt.now() + datetime.timedelta(seconds=4))
  &gt;&gt;&gt; deep_eq(d1, d2)
  False
  &gt;&gt;&gt; deep_eq(d1, d2, datetime_fudge=datetime.timedelta(seconds=5))
  True
  &quot;&quot;&quot;
  _deep_eq = functools.partial(deep_eq, datetime_fudge=datetime_fudge,
                               _assert=_assert)

  def _check_assert(R, a, b, reason=&#39;&#39;):
    if _assert and not R:
      assert 0, &quot;an assertion has failed in deep_eq (%s) %s != %s&quot; % (
        reason, str(a), str(b))
    return R

  def _deep_dict_eq(d1, d2):
    k1, k2 = (sorted(d1.keys()), sorted(d2.keys()))
    if k1 != k2: # keys should be exactly equal
      return _check_assert(False, k1, k2, &quot;keys&quot;)

    return _check_assert(operator.eq(sum(_deep_eq(d1[k], d2[k])
                                       for k in k1),
                                     len(k1)), d1, d2, &quot;dictionaries&quot;)

  def _deep_iter_eq(l1, l2):
    if len(l1) != len(l2):
      return _check_assert(False, l1, l2, &quot;lengths&quot;)
    return _check_assert(operator.eq(sum(_deep_eq(v1, v2)
                                      for v1, v2 in zip(l1, l2)),
                                     len(l1)), l1, l2, &quot;iterables&quot;)

  def op(a, b):
    _op = operator.eq
    if type(a) == datetime.datetime and type(b) == datetime.datetime:
      s = datetime_fudge.seconds
      t1, t2 = (time.mktime(a.timetuple()), time.mktime(b.timetuple()))
      l = t1 - t2
      l = -l if l &gt; 0 else l
      return _check_assert((-s if s &gt; 0 else s) &lt;= l, a, b, &quot;dates&quot;)
    return _check_assert(_op(a, b), a, b, &quot;values&quot;)

  c1, c2 = (_v1, _v2)

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>guard against strings because they are iterable and their
elements yield iterables infinitely.
I N C E P T I O N</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  <span class="k">for</span> <span class="n">t</span> <span class="n">in</span> <span class="n">types</span><span class="p">.</span><span class="n">StringTypes</span><span class="o">:</span>
    <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">_v1</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span><span class="o">:</span>
      <span class="k">break</span>
  <span class="nl">else:</span>
    <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">_v1</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">DictType</span><span class="p">)</span><span class="o">:</span>
      <span class="n">op</span> <span class="o">=</span> <span class="n">_deep_dict_eq</span>
    <span class="nl">else:</span>
      <span class="nl">try:</span>
        <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="n">iter</span><span class="p">(</span><span class="n">_v1</span><span class="p">)),</span> <span class="n">list</span><span class="p">(</span><span class="n">iter</span><span class="p">(</span><span class="n">_v2</span><span class="p">)))</span>
      <span class="n">except</span> <span class="n">TypeError</span><span class="o">:</span>
        <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">_v1</span><span class="p">,</span> <span class="n">_v2</span>
      <span class="nl">else:</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">_deep_iter_eq</span>

  <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>











</pre></div>
</div>
</div>
<div class="section" id="code-for-this-program">
<h2>Code for this program<a class="headerlink" href="#code-for-this-program" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c"><div class="highlight"><pre>
<span class="n">import</span> <span class="n">csv</span>

</pre></div>
</div>
<p>Enumerate all ports on a PIC24 processor, returning the result as a list.</p>
<div class="highlight-c"><div class="highlight"><pre>
<span class="n">def</span> <span class="n">enumeratePic24Ports</span><span class="p">()</span><span class="o">:</span>
    <span class="n">port_letters</span> <span class="o">=</span> <span class="p">[</span><span class="n">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="n">ord</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">),</span> <span class="n">ord</span><span class="p">(</span><span class="sc">&#39;K&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The PIC series doesn&#8217;t have port I.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
    <span class="n">port_letters</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">port_letters</span>
                       <span class="k">for</span> <span class="n">j</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">16</span><span class="p">)]</span>

</pre></div>
</div>
<p>This routine builds pic24_ports_tables.h from a template. To do so:</p>
<ol class="arabic simple">
<li>Open the output file and write out the header.</li>
<li>Load in the CSV file containing pin information:<ol class="arabic">
<li>Load three rows; they should be labeled xxx RPy, xxx ANn, and xxx CNm, where xxx is the processor.</li>
<li>For each Rxy value:<ol class="arabic">
<li>For F/H devices: look at the corresponding RPy, ANn, and CNm. If any are non-empty, write a table entry.</li>
<li>For E devices: Write a #define for RPy or ANn if either are non-empty.</li>
</ol>
</li>
</ol>
</li>
<li>Write out the footer.</li>
</ol>
<div class="highlight-c"><div class="highlight"><pre>
<span class="n">def</span> <span class="n">genTablesFromTemplate</span><span class="p">(</span><span class="n">csvFileName</span><span class="p">,</span> <span class="n">destFileName</span><span class="p">)</span><span class="o">:</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Read in the CSV containing device information.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
    <span class="n">processors</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>
    <span class="n">with</span> <span class="n">open</span><span class="p">(</span><span class="n">csvFileName</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="n">as</span> <span class="n">csvFile</span><span class="o">:</span>
        <span class="n">csv_dict_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvFile</span><span class="p">).</span><span class="n">__iter__</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Walk through the file</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
        <span class="k">while</span> <span class="n">True</span><span class="o">:</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Read three rows</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
            <span class="nl">try:</span>
                <span class="n">RPy</span> <span class="o">=</span> <span class="n">csv_dict_reader</span><span class="p">.</span><span class="n">next</span><span class="p">()</span>
                <span class="n">ANn</span> <span class="o">=</span> <span class="n">csv_dict_reader</span><span class="p">.</span><span class="n">next</span><span class="p">()</span>
                <span class="n">CNm</span> <span class="o">=</span> <span class="n">csv_dict_reader</span><span class="p">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">except</span> <span class="n">StopIteration</span><span class="o">:</span>
                <span class="k">break</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Get processor information and remove it (to avoid breaking the comparisons)</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
            processor_name = RPy[&#39;Device port / pin&#39;][:-4]
            del RPy[&#39;Device port / pin&#39;]
            del ANn[&#39;Device port / pin&#39;]
            del CNm[&#39;Device port / pin&#39;]
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Look for a duplicate</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
            processor_value = (RPy, ANn, CNm)
            found = False
            for processor in processors:
                if deep_eq(processors[processor], processor_value):
                    #print(&quot;%s duplicates %s.&quot; % (processor, processor_name))
                    found = True
                    processors[processor + &#39; &#39; + processor_name] = processor_value
                    del processors[processor]
            if not found:
                processors[processor_name] = processor_value

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Open the output file.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
    #print(processors)
    with open(destFileName, &quot;wb&quot;) as outFile:
        portlist = enumeratePic24Ports()
        portlist.insert(0, &#39;Device port / pin&#39;)
        csv_dict_writer = csv.DictWriter(outFile, portlist)
        csv_dict_writer.writeheader()

        for processor in sorted(processors.keys()):
            RPy, ANn, CNm = processors[processor]
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Remove any duplicates and write out processor names in sorted order.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
            processor = &#39; &#39;.join(sorted(set(processor.split(&#39; &#39;))))
            RPy[&#39;Device port / pin&#39;] = processor + &#39; RPy&#39;
            ANn[&#39;Device port / pin&#39;] = processor + &#39; ANn&#39;
            CNm[&#39;Device port / pin&#39;] = processor + &#39; CNm&#39;
            csv_dict_writer.writerow(RPy)
            csv_dict_writer.writerow(ANn)
            csv_dict_writer.writerow(CNm)


if __name__ == &#39;__main__&#39;:
    genTablesFromTemplate(&#39;pic24_devices.csv&#39; , &#39;pic24_devices_combined.csv&#39;)
</pre></div>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../util/dataXfer_test.c.html" title="dataXfer_test.c - Runs unit tests on PIC data transfor protocol"
             >next</a> |</li>
        <li class="right" >
          <a href="data_sheet_to_csv.py.html" title="data_sheet_to_csv.py - GUI to assist in translating Microchip data sheets to pin mappings"
             >previous</a> |</li>
        <li><a href="../contents.html">Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 4-Jun-2013 documentation</a> &raquo;</li>
          <li><a href="../utilities.html" >Utilities</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Bryan A. Jones, Robert B. Reese, and J. W. Bruce.
      Last updated on Oct 30, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>