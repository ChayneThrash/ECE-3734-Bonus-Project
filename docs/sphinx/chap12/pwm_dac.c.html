<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pwm_dac.c - Demonstrates a PWM DAC &mdash; Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 4-Jun-2013 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '4-Jun-2013',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 4-Jun-2013 documentation" href="../index.html" />
    <link rel="up" title="Textbook examples" href="../textbook_examples.html" />
    <link rel="next" title="time1_sosc.c - Demonstrates use of Timer1 with a secondary oscillator." href="timer1_sosc.c.html" />
    <link rel="prev" title="ledpwm.c - Demonstrates pulse width modulation by controlling the intensity of an LED. The ADC input value on AN0 is used to vary the PWM period." href="ledpwm_bullymon.c.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="timer1_sosc.c.html" title="time1_sosc.c - Demonstrates use of Timer1 with a secondary oscillator."
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ledpwm_bullymon.c.html" title="ledpwm.c - Demonstrates pulse width modulation by controlling the intensity of an LED. The ADC input value on AN0 is used to vary the PWM period."
             accesskey="P">previous</a> |</li>
        <li><a href="../contents.html">Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 4-Jun-2013 documentation</a> &raquo;</li>
          <li><a href="../textbook_examples.html" accesskey="U">Textbook examples</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="pwm-dac-c-demonstrates-a-pwm-dac">
<h1>pwm_dac.c - Demonstrates a PWM DAC<a class="headerlink" href="#pwm-dac-c-demonstrates-a-pwm-dac" title="Permalink to this headline">Â¶</a></h1>
<p>Demonstrates a PWM DAC - connect an RC filter on the OC1
output and vary the pulse width of the PWM signal, and monitor
the DC value on the capacitor. The RC time constant should
be at least 10x greater than the PWM period. Examples values
used for testing were R=6.8k, C = 1.0u, PWM period= 500 us
In this code, the pulse width of the PWM signal is varied by reading
an analog voltage generated by a potentiomer, same as in the ledpwm.c example.
So, this duplicates the input voltage on the output of the PWM DAC.</p>
<div class="highlight-c"><div class="highlight"><pre>

<span class="cp">#include &quot;pic24_all.h&quot;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>



<span class="cp">#ifndef PWM_PERIOD</span>
<span class="cp">#define PWM_PERIOD 500  </span><span class="c1">// desired period, in us</span>
<span class="cp">#endif</span>

<span class="kt">void</span>  <span class="nf">configTimer2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">T2CON</span> <span class="o">=</span> <span class="n">T2_OFF</span> <span class="o">|</span> <span class="n">T2_IDLE_CON</span> <span class="o">|</span> <span class="n">T2_GATE_OFF</span>
          <span class="o">|</span> <span class="n">T2_32BIT_MODE_OFF</span>
          <span class="o">|</span> <span class="n">T2_SOURCE_INT</span>
          <span class="o">|</span> <span class="n">T2_PS_1_8</span> <span class="p">;</span>  <span class="c1">//1 tick = 1.6 us at FCY=40 MHz</span>
  <span class="n">PR2</span> <span class="o">=</span> <span class="n">usToU16Ticks</span><span class="p">(</span><span class="n">PWM_PERIOD</span><span class="p">,</span> <span class="n">getTimerPrescale</span><span class="p">(</span><span class="n">T2CONbits</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">TMR2</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="c1">//clear timer2 value</span>
  <span class="n">_T2IF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">_T2IP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">_T2IE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">//enable the Timer2 interrupt</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">configOutputCompare1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">T2CONbits</span><span class="p">.</span><span class="n">TON</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>          <span class="c1">//disable Timer when configuring Output compare</span>
  <span class="n">CONFIG_OC1_TO_RP</span><span class="p">(</span><span class="n">RB4_RP</span><span class="p">);</span>   <span class="c1">//map OC1 to RB4</span>
  <span class="n">OC1RS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">//clear both registers</span>
  <span class="n">OC1R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef OC1CON1</span>
<span class="c1">//turn on the compare toggle mode using Timer2</span>
  <span class="n">OC1CON1</span> <span class="o">=</span> <span class="n">OC_TIMER2_SRC</span> <span class="o">|</span>     <span class="c1">//Timer2 source</span>
            <span class="n">OC_PWM_CENTER_ALIGN</span><span class="p">;</span>  <span class="c1">//PWM</span>
  <span class="n">OC1CON2</span> <span class="o">=</span> <span class="n">OC_SYNCSEL_TIMER2</span><span class="p">;</span>   <span class="c1">//synchronize to timer2</span>
<span class="cp">#else</span>
<span class="c1">//older families, this PWM mode is compatible with center-aligned, OC1R=0</span>
<span class="c1">//as writes to OC1RS sets the pulse widith.</span>
  <span class="n">OC1CON</span> <span class="o">=</span> <span class="n">OC_TIMER2_SRC</span> <span class="o">|</span>     <span class="c1">//Timer2 source</span>
           <span class="n">OC_PWM_FAULT_PIN_DISABLE</span><span class="p">;</span>  <span class="c1">//PWM, no fault detection</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">_ISR</span> <span class="nf">_T2Interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">uint32_t</span> <span class="n">u32_temp</span><span class="p">;</span>
  <span class="n">_T2IF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">//clear the timer interrupt bit</span>
  <span class="c1">//update the PWM duty cycle from the ADC value</span>
  <span class="n">u32_temp</span> <span class="o">=</span> <span class="n">ADC1BUF0</span><span class="p">;</span>  <span class="c1">//use 32-bit value for range</span>
  <span class="c1">//compute new pulse width that is 0 to 99% of PR2</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>pulse width (PR2) * ADC/1024</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  <span class="n">u32_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32_temp</span> <span class="o">*</span> <span class="p">(</span><span class="n">PR2</span><span class="p">))</span><span class="o">&gt;&gt;</span> <span class="mi">10</span> <span class="p">;</span>  <span class="c1">// &gt;&gt;10 is same as divide/1024</span>
  <span class="n">OC1RS</span> <span class="o">=</span> <span class="n">u32_temp</span><span class="p">;</span>  <span class="c1">//update pulse width value</span>
  <span class="n">AD1CON1bits</span><span class="p">.</span><span class="n">SAMP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//start next ADC conversion for next interrupt</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">uint16_t</span> <span class="n">u16_oc1rs</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">u32_pw</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">f_dacV</span><span class="p">;</span>
  <span class="n">configBasic</span><span class="p">(</span><span class="n">HELLO_MSG</span><span class="p">);</span>
  <span class="n">configTimer2</span><span class="p">();</span>
  <span class="n">configOutputCompare1</span><span class="p">();</span>
  <span class="n">CONFIG_RA0_AS_ANALOG</span><span class="p">();</span>
  <span class="n">configADC1_ManualCH0</span><span class="p">(</span><span class="n">RA0_AN</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">SET_SAMP_BIT_ADC1</span><span class="p">();</span>      <span class="c1">//start sampling and conversion</span>
  <span class="n">T2CONbits</span><span class="p">.</span><span class="n">TON</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>       <span class="c1">//turn on Timer2 to start PWM</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">u16_oc1rs</span> <span class="o">=</span> <span class="n">OC1RS</span><span class="p">;</span>
    <span class="n">u32_pw</span><span class="o">=</span> <span class="n">ticksToUs</span><span class="p">(</span><span class="n">u16_oc1rs</span><span class="p">,</span> <span class="n">getTimerPrescale</span><span class="p">(</span><span class="n">T2CONbits</span><span class="p">));</span>
    <span class="n">f_dacV</span> <span class="o">=</span> <span class="n">u16_oc1rs</span><span class="p">;</span>
    <span class="n">f_dacV</span> <span class="o">=</span> <span class="n">f_dacV</span> <span class="o">*</span> <span class="mf">3.3</span><span class="o">/</span><span class="p">(</span><span class="n">PR2</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;PWM PW (us): %ld, PWM DAC voltage: %4.2f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">u32_pw</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="n">f_dacV</span><span class="p">);</span>
    <span class="n">DELAY_MS</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="timer1_sosc.c.html" title="time1_sosc.c - Demonstrates use of Timer1 with a secondary oscillator."
             >next</a> |</li>
        <li class="right" >
          <a href="ledpwm_bullymon.c.html" title="ledpwm.c - Demonstrates pulse width modulation by controlling the intensity of an LED. The ADC input value on AN0 is used to vary the PWM period."
             >previous</a> |</li>
        <li><a href="../contents.html">Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 4-Jun-2013 documentation</a> &raquo;</li>
          <li><a href="../textbook_examples.html" >Textbook examples</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Bryan A. Jones, Robert B. Reese, and J. W. Bruce.
      Last updated on Oct 30, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>