<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SConstruct.py - Build all libraries and examples over many chips &mdash; Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 4-Jun-2013 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '4-Jun-2013',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 4-Jun-2013 documentation" href="index.html" />
    <link rel="up" title="Utilities" href="utilities.html" />
    <link rel="next" title="SCons_bootloader.py - Build the bootloader" href="SCons_bootloader.py.html" />
    <link rel="prev" title="runscons.bat - Run SCons, collecting and filtering warnings" href="runscons.bat.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="SCons_bootloader.py.html" title="SCons_bootloader.py - Build the bootloader"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="runscons.bat.html" title="runscons.bat - Run SCons, collecting and filtering warnings"
             accesskey="P">previous</a> |</li>
        <li><a href="contents.html">Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 4-Jun-2013 documentation</a> &raquo;</li>
          <li><a href="utilities.html" accesskey="U">Utilities</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="sconstruct-py-build-all-libraries-and-examples-over-many-chips">
<h1><a class="toc-backref" href="#id1">SConstruct.py - Build all libraries and examples over many chips</a><a class="headerlink" href="#sconstruct-py-build-all-libraries-and-examples-over-many-chips" title="Permalink to this headline">¶</a></h1>
<p>This file contains all that a SConstruct file normally contains.
In order to use CodeChat, however, all Python files must end with
a <tt class="docutils literal"><span class="pre">.py</span></tt> extension. So, SConstuct simply executes this file.</p>
<blockquote>
<div><p>This file provides an automated build process for the
ref index &#8220;libraries&#8221; included in this collection.
To use:</p>
<ol class="arabic simple">
<li>Install SCons.</li>
<li>Install the Microchip compiler. Make sure your path
includes the directories in which the compiler binaries
exist.</li>
<li>From the command line, change to the directory in which
this file lies.</li>
<li>Execute <tt class="docutils literal"><span class="pre">SCons</span></tt>, which builds everything. Optionally use
<a class="reference internal" href="runscons.bat.html"><em>runscons.bat</em></a> to filter through the resulting warnings.</li>
</ol>
<p>The build process can be modified by passing options to
SCons. See <tt class="docutils literal"><span class="pre">SCons</span> <span class="pre">--help</span></tt> for options specific
to this build and <tt class="docutils literal"><span class="pre">SCons</span> <span class="pre">-H</span></tt> for generic SCons
options.</p>
</div></blockquote>
<p>The generated build targets follow the naming convention:</p>
<blockquote>
<div>[bootloader/esos]_hardware platform_mcu_[clock/nofloat]</div></blockquote>
<p>This module perfoms builds over a variety of CPUs and configurations.
The files listed below specify a set of targets used in each of these builds.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="SCons_bootloader.py.html">SCons_bootloader.py - Build the bootloader</a></li>
<li class="toctree-l1"><a class="reference internal" href="SCons_build.py.html">SCons_build.py - Build all libraries and examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="SCons_build.py.html#common-sources-used-for-the-pic24-support-library">Common sources used for the PIC24 support library</a></li>
<li class="toctree-l2"><a class="reference internal" href="SCons_build.py.html#functions-used-to-build-the-library">Functions used to build the library</a></li>
<li class="toctree-l2"><a class="reference internal" href="SCons_build.py.html#definition-of-targets">Definition of targets</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="SCons_esos.py.html">SCons_esos.py - Build ESOS chapter 14 applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="SCons_zipit.py.html">SCons_zipit.py - Build docs then create a .zip for distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="templates/SConscript.py.html">SConscript.py - Build source files from template</a><ul>
<li class="toctree-l2"><a class="reference internal" href="templates/SConscript.py.html#setup-for-template-building">Setup for template building</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates/SConscript.py.html#functions-supporting-template-file-builds">Functions supporting template file builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates/SConscript.py.html#calls-to-build-templates">Calls to build templates</a></li>
</ul>
</li>
</ul>
</div>
<p>The overall structure of this file is:</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#sconstruct-py-build-all-libraries-and-examples-over-many-chips" id="id1">SConstruct.py - Build all libraries and examples over many chips</a><ul>
<li><a class="reference internal" href="#create-a-microchip-xc16-construction-environment" id="id2">Create a Microchip XC16 Construction Environment</a><ul>
<li><a class="reference internal" href="#create-a-bin2hex-builder" id="id3">Create a bin2hex builder</a></li>
<li><a class="reference internal" href="#command-line-options" id="id4">Command-line options</a></li>
</ul>
</li>
<li><a class="reference internal" href="#definition-of-targets" id="id5">Definition of targets</a></li>
<li><a class="reference internal" href="#library-builds" id="id6">Library builds</a><ul>
<li><a class="reference internal" href="#build-over-various-mcus" id="id7">Build over various MCUs</a></li>
<li><a class="reference internal" href="#build-over-various-hardware-platforms" id="id8">Build over various hardware platforms</a></li>
<li><a class="reference internal" href="#build-over-various-clocks" id="id9">Build over various clocks</a></li>
<li><a class="reference internal" href="#misc-builds" id="id10">Misc builds</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bootloader-builds" id="id11">Bootloader builds</a></li>
<li><a class="reference internal" href="#esos-builds" id="id12">ESOS builds</a></li>
</ul>
</li>
</ul>
</div>
<div class="highlight-c"><div class="highlight"><pre>

<span class="n">import</span> <span class="n">os</span>
<span class="n">import</span> <span class="n">psutil</span>

</pre></div>
</div>
<p>Make sure SCons is recent enough.</p>
<div class="highlight-c"><div class="highlight"><pre>
<span class="n">EnsureSConsVersion</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


</pre></div>
</div>
<div class="section" id="create-a-microchip-xc16-construction-environment">
<h2><a class="toc-backref" href="#id2">Create a Microchip XC16 Construction Environment</a><a class="headerlink" href="#create-a-microchip-xc16-construction-environment" title="Permalink to this headline">¶</a></h2>
<p>Define command-line options to set bootloader.
The Environment below depends on opts, so this must go here instead of with
the rest of the <a class="reference internal" href="#command-line-options">Command-line options</a>.</p>
<div class="highlight-c"><div class="highlight"><pre>
opts = Variables()
opts.Add(EnumVariable(&#39;BOOTLDR&#39;, &#39;Determines bootloader type&#39;, &#39;msu&#39;,
                    allowed_values=(&#39;msu&#39;, &#39;none&#39;)))

</pre></div>
</div>
<p>Create the environment.</p>
<div class="highlight-c"><div class="highlight"><pre>
<span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Force SCons to set up with gnu tools to start
with reasonable defaults. Note: using platform = &#8216;posix&#8217;
causes SCons to try to call fork() when executing programs
(such as compilers), which errors out on Windows.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
        tools = [&#39;gcc&#39;, &#39;gnulink&#39;, &#39;ar&#39;, &#39;zip&#39;, &#39;packaging&#39;],
        options = opts,
        CPPPATH = &#39;lib/include&#39;,
        CC = &#39;xc16-gcc&#39;,
        LIBPATH = &#39;.&#39;,
        AR = &#39;xc16-ar&#39;,
        LINK = &#39;xc16-gcc&#39;,
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Copied and cobbled together from SConsToolscc.py with mods</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
        CCCOM = &#39;$CC -c -o $TARGET $CFLAGS $CCFLAGS $CPPFLAGS $_CPPDEFFLAGS $_CPPINCFLAGS $SOURCES&#39;,
        CCCCOMSTR = &#39;Compiling $SOURCES&#39;,
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>The warnings provide some lint-like checking. Omitted options: -Wstrict-prototypes -Wold-style-definition complains about void foo(), which should be void foo(void), but isn&#8217;t worth the work to change.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
        CCFLAGS = &#39;-mcpu=${MCU} -O1 -msmart-io=1 -omf=elf -Wall -Wextra -Wdeclaration-after-statement -Wlong-long -fdiagnostics-show-option&#39;,
        LINKFLAGS = &#39;-mcpu=${MCU} -omf=elf -Wl,--heap=100,$LINKERSCRIPT,--stack=16,--check-sections,--data-init,--pack-data,--handles,--isr,--no-gc-sections,--fill-upper=0,--stackguard=16,--no-force-link,--smart-io,--no-cpp&#39;,
        LINKERSCRIPT = &#39;--script=&quot;lib/lkr/p${MCU}_bootldr.gld&quot;&#39;,
        ARFLAGS = &#39;rcs&#39;,
        ARSTR = &#39;Create static library: $TARGET&#39;,
        OBJSUFFIX = &#39;.o&#39;,
        PROGSUFFIX = &#39;.elf&#39;,
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Copy the host envrionment variables for our scons environment
so scons can find the build tools and related env vars.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
        <span class="n">ENV</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">,</span>
      <span class="p">)</span>

</pre></div>
</div>
<div class="section" id="create-a-bin2hex-builder">
<h3><a class="toc-backref" href="#id3">Create a bin2hex builder</a><a class="headerlink" href="#create-a-bin2hex-builder" title="Permalink to this headline">¶</a></h3>
<p>Add the bin2hex function to the environment as a new builder
This functions converts a binary (.elf or .cof) file to a hex file.</p>
<div class="highlight-c"><div class="highlight"><pre>
<span class="n">def</span> <span class="n">bin2hex</span><span class="p">(</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>The name of the .elf/.cof file to be converted.</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  <span class="n">binName</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>An Environment in which to build these sources.</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  <span class="n">buildEnvironment</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>A string to serve as an alias for this build.</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  <span class="n">aliasString</span><span class="p">)</span><span class="o">:</span>

  <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">binName</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">myHex</span> <span class="o">=</span> <span class="n">buildEnvironment</span><span class="p">.</span><span class="n">Hex</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>Add this hex file to a convenient alias</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  buildEnvironment.Alias(aliasString, myHex)

b2h = Builder(
        action = &#39;xc16-bin2hex $SOURCE -a -omf=elf&#39;,
        suffix = &#39;hex&#39;,
        src_suffix = &#39;elf&#39;)
env.Append(BUILDERS = {&#39;Hex&#39; : b2h})


</pre></div>
</div>
</div>
<div class="section" id="command-line-options">
<h3><a class="toc-backref" href="#id4">Command-line options</a><a class="headerlink" href="#command-line-options" title="Permalink to this headline">¶</a></h3>
<p>adjust our default environment based on user command-line requests</p>
<div class="highlight-c"><div class="highlight"><pre>
dict = env.Dictionary()
if dict[&#39;BOOTLDR&#39;] != &#39;msu&#39;:
    env.Replace(LINKERSCRIPT = &#39;--script=&quot;p${MCU}.gld&quot;&#39;)

</pre></div>
</div>
<p>By default, run number_of_cpus*4 jobs at once. This only works if the &#8211;no-cpp option is passed to the linker; otherwise, the linker produces a temporary file in the root build directory, which gets overwritten and confused when multiple builds run. There&#8217;s some nice examples and explanation for this in the <a class="reference external" href="http://www.scons.org/doc/production/HTML/scons-user/c2092.html#AEN2183">SCons user guide</a>.</p>
<p>Some results from running on my 8-core PC:, gathered from the Total build time returned by the &#8211;debug=time scons command-line option:</p>
<table border="1" class="docutils">
<colgroup>
<col width="5%" />
<col width="26%" />
<col width="38%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">-j</th>
<th class="head">Time (sec)</th>
<th class="head">Time (hh:mm:ss)</th>
<th class="head">Speedup</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>32</td>
<td>303</td>
<td>0:05:03</td>
<td>11.66006601</td>
</tr>
<tr class="row-odd"><td>16</td>
<td>348.7</td>
<td>0:05:49</td>
<td>10.13191855</td>
</tr>
<tr class="row-even"><td>8</td>
<td>510.9</td>
<td>0:08:31</td>
<td>6.915247602</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>916</td>
<td>0:15:16</td>
<td>3.8569869</td>
</tr>
<tr class="row-even"><td>2</td>
<td>1777</td>
<td>0:29:37</td>
<td>1.98818233</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>3533</td>
<td>0:58:53</td>
<td>1</td>
</tr>
</tbody>
</table>
<div class="highlight-c"><div class="highlight"><pre>

env.SetOption(&#39;num_jobs&#39;, psutil.NUM_CPUS*4)
print(&quot;Running with -j %d.&quot; % GetOption(&#39;num_jobs&#39;))

</pre></div>
</div>
<p>generate some command line help for our custom options</p>
<div class="highlight-c"><div class="highlight"><pre>
<span class="n">Help</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="n">GenerateHelpText</span><span class="p">(</span><span class="n">env</span><span class="p">))</span>
<span class="n">Help</span><span class="p">(</span><span class="s">&quot;&quot;&quot;Additional targets:</span>
  <span class="n">template</span><span class="o">-</span><span class="n">build</span><span class="o">:</span> <span class="n">Build</span> <span class="n">all</span> <span class="p">.</span><span class="n">c</span><span class="o">/</span><span class="p">.</span><span class="n">h</span> <span class="n">files</span> <span class="n">which</span> <span class="n">are</span> <span class="n">produced</span> <span class="n">by</span> <span class="n">templates</span><span class="p">.</span>
  <span class="nl">zipit:</span> <span class="n">Build</span> <span class="n">an</span> <span class="n">archive</span> <span class="k">for</span> <span class="n">distributing</span> <span class="n">end</span><span class="o">-</span><span class="n">user</span> <span class="n">library</span> <span class="n">contents</span><span class="p">.</span>
  <span class="nl">bootloader:</span> <span class="n">Build</span> <span class="n">the</span> <span class="n">bootloader</span> <span class="n">binaries</span> <span class="n">only</span><span class="p">.</span><span class="s">&quot;&quot;&quot;)</span>

</pre></div>
</div>
<p>A DEBUG STATEMENT to see what the scons build envrionment (env) has defined</p>
<div class="highlight-c"><div class="highlight"><pre>
<span class="cp">#print   env.Dump()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="definition-of-targets">
<h2><a class="toc-backref" href="#id5">Definition of targets</a><a class="headerlink" href="#definition-of-targets" title="Permalink to this headline">¶</a></h2>
<p>First, set up for defining targets.</p>
<p>Inform SCons about the dependencies in the template-based files</p>
<div class="highlight-c"><div class="highlight"><pre>
SConscript(&#39;templates/SConscript.py&#39;, &#39;env&#39;)

</pre></div>
</div>
<p>Create a target which zips up library files. Only built it if explicitly requested on the command line.</p>
<div class="highlight-c"><div class="highlight"><pre>
if &#39;zipit&#39; in COMMAND_LINE_TARGETS:
    zip_file = &#39;build/pic24_code_examples.zip&#39;
    hg_dir = &#39;build/pic24lib_all&#39;
    env.Command(zip_file, &#39;&#39;, [
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Clone the repo to create a clean distribution.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
      Delete(hg_dir, must_exist = 0),
      &#39;hg clone . &#39; + hg_dir,
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Copy over hex files from the build.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
      Copy(hg_dir + &#39;/hex&#39;, &#39;hex&#39;),
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Perform zip in clean clone.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
      &#39;scons -C &#39; + hg_dir + &#39; -f SCons_zipit.py&#39;, ])
    env.Alias(&#39;zipit&#39;, zip_file)
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Only build this if it&#8217;s explicitly requested. Since the dependencies of &#8216;&#8217; are wrong, force a build using AlwaysBuild.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
    <span class="n">env</span><span class="p">.</span><span class="n">AlwaysBuild</span><span class="p">(</span><span class="n">zip_file</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="section" id="library-builds">
<h2><a class="toc-backref" href="#id6">Library builds</a><a class="headerlink" href="#library-builds" title="Permalink to this headline">¶</a></h2>
<p>Call <a class="reference internal" href="SCons_build.py.html"><em>SCons_build.py - Build all libraries and examples</em></a> with a specific buildTargets value. It create a variant build
named <tt class="docutils literal"><span class="pre">hardware_platform</span> <span class="pre">_</span> <span class="pre">MCU</span> <span class="pre">_</span> <span class="pre">clock</span></tt>.</p>
<div class="highlight-c"><div class="highlight"><pre>
<span class="n">def</span> <span class="n">buildTargetsSConscript</span><span class="p">(</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>A list of library targets to build, as defined in <a class="reference internal" href="SCons_build.py.html"><em>SCons_build.py - Build all libraries and examples</em></a>.</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  <span class="n">buildTargets</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>The Environment to use for building. Use <tt class="docutils literal"><span class="pre">env.Clone(MCU='blah',</span> <span class="pre">CPPDEFINES='blah'</span></tt>
to choose a MCU, clock, and hardware platform as desired.</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  <span class="n">env</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>A string giving the name of the hardware platform.</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  <span class="n">hardware_platform</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>The same of the clock chosen, or of some special build option (such as
nofloat).</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  extra_defines = &#39;&#39;):
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>Build a variant directory name, based on the hardware platform, MCU, and extra defines (if any)</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  vdir = &#39;build/&#39; + &#39;_&#39;.join([hardware_platform, env[&#39;MCU&#39;]])
  if extra_defines:
    vdir += &#39;_&#39; + extra_defines
  SConscript(&#39;SCons_build.py&#39;, exports = &#39;buildTargets env bin2hex&#39;,
    variant_dir = vdir)

</pre></div>
</div>
<div class="section" id="build-over-various-mcus">
<h3><a class="toc-backref" href="#id7">Build over various MCUs</a><a class="headerlink" href="#build-over-various-mcus" title="Permalink to this headline">¶</a></h3>
<p>Build small, non-DMA on the PIC24HJ32GP202</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;chap08&#39;, &#39;chap09&#39;, &#39;chap10&#39;, &#39;chap11&#39;, &#39;chap12&#39;],
env.Clone(MCU=&#39;24HJ64GP202&#39;), &#39;default&#39;)

</pre></div>
</div>
<p>Build everything on the PIC24FJ64GA002</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;chap08&#39;, &#39;chap09&#39;, &#39;chap10&#39;, &#39;chap11&#39;, &#39;chap12&#39;,
                        &#39;chap15&#39;],
  env.Clone(MCU=&#39;24FJ64GA002&#39;), &#39;default&#39;)

</pre></div>
</div>
<p>Build small, non-DMA on the dsPIC33FJ32GP202</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;chap08&#39;, &#39;chap09&#39;, &#39;chap10&#39;,                &#39;chap11&#39;, &#39;chap12&#39;],
  env.Clone(MCU=&#39;33FJ64GP202&#39;), &#39;default&#39;)

</pre></div>
</div>
<p>Minimally test the 24F16KA102. It has hardmapped UART pins.</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;reset&#39;, &#39;echo&#39;],
  env.Clone(MCU=&#39;24F32KA302&#39;, CPPDEFINES=&#39;HARDWARE_PLATFORM=HARDMAPPED_UART&#39;), &#39;hardmappedUART&#39;)

</pre></div>
</div>
<p>Build the PIC24HJ64GP502-compatible directories.</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;chap11&#39;, &#39;chap13&#39;, &#39;chap15&#39;],
  env.Clone(MCU=&#39;24HJ64GP502&#39;), &#39;default&#39;)

</pre></div>
</div>
<p>Same as above, but for a dsPIC</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;chap08&#39;, &#39;chap09&#39;, &#39;chap10&#39;, &#39;chap11&#39;, &#39;chap12&#39;,
                        &#39;chap13&#39;, &#39;chap15&#39;],
  env.Clone(MCU=&#39;33FJ128GP802&#39;), &#39;default&#39;)

</pre></div>
</div>
<p>Same as above, but for the dsPIC33EP128GP502</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;chap08&#39;, &#39;chap09&#39;, &#39;chap10&#39;, &#39;chap12&#39;,
                        &#39;chap13&#39;, &#39;chap15&#39;],
  env.Clone(MCU=&#39;33EP128GP502&#39;), &#39;default&#39;)

</pre></div>
</div>
<p>Build some for the PIC24E device</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;chap08&#39;, &#39;chap09&#39;, &#39;chap10&#39;, &#39;chap11&#39;,  &#39;chap12&#39;],
  env.Clone(MCU=&#39;24EP64GP202&#39;), &#39;default&#39;)

</pre></div>
</div>
</div>
<div class="section" id="build-over-various-hardware-platforms">
<h3><a class="toc-backref" href="#id8">Build over various hardware platforms</a><a class="headerlink" href="#build-over-various-hardware-platforms" title="Permalink to this headline">¶</a></h3>
<p>Same as above, but for the dsPIC33EP128GP502 on a MicroStickII target</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;chap08&#39;, &#39;chap09&#39;, &#39;chap10&#39;, &#39;chap12&#39;,
                        &#39;chap13&#39;, &#39;chap15&#39;],
  env.Clone(MCU=&#39;33EP128GP502&#39;, CPPDEFINES=&#39;HARDWARE_PLATFORM=MICROSTICK2&#39;), &#39;microstick2&#39;)

</pre></div>
</div>
<p>Build some selected chapter applications for the chip used on the Fall 2013 Embedded systems board</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;chap08&#39;, &#39;chap09&#39;, &#39;chap13&#39;],
  env.Clone(MCU=&#39;33EP128GP504&#39;, CPPDEFINES=&#39;HARDWARE_PLATFORM=EMBEDDED_C1&#39;), &#39;embeddedC1&#39;)

</pre></div>
</div>
<p>Build some for the CAN2 rev.F14 board used in ECE4723 Embedded Systems</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;chap08&#39;, &#39;chap09&#39;],
  env.Clone(MCU=&#39;33EP512GP806&#39;, CPPDEFINES=&#39;HARDWARE_PLATFORM=EMBEDDED_F14&#39;), &#39;embeddedF14&#39;)

</pre></div>
</div>
<p>Build for the explorer board</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;explorer&#39;],
  env.Clone(MCU=&#39;24FJ128GA010&#39;, CPPDEFINES=&#39;HARDWARE_PLATFORM=EXPLORER16_100P&#39;), &#39;explorer16100p&#39;)
buildTargetsSConscript([&#39;explorer&#39;],
  env.Clone(MCU=&#39;24HJ256GP610&#39;, CPPDEFINES=&#39;HARDWARE_PLATFORM=EXPLORER16_100P&#39;), &#39;explorer16100p&#39;)

</pre></div>
</div>
<p>Build reset on other supported platforms</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;reset&#39;],
  env.Clone(MCU=&#39;24FJ64GA002&#39;,  CPPDEFINES=&#39;HARDWARE_PLATFORM=STARTER_BOARD_28P&#39;), &#39;starterboard28p&#39;)
buildTargetsSConscript([&#39;reset&#39;],
  env.Clone(MCU=&#39;33FJ128GP204&#39;, CPPDEFINES=&#39;HARDWARE_PLATFORM=DANGEROUS_WEB&#39;), &#39;dangerousweb&#39;)

</pre></div>
</div>
</div>
<div class="section" id="build-over-various-clocks">
<h3><a class="toc-backref" href="#id9">Build over various clocks</a><a class="headerlink" href="#build-over-various-clocks" title="Permalink to this headline">¶</a></h3>
<p>Build reset with various clock options on all processors</p>
<div class="highlight-c"><div class="highlight"><pre>
for clock in [&#39;SIM_CLOCK&#39;, &#39;FRCPLL_FCY16MHz&#39;, &#39;FRC_FCY4MHz&#39;,
  &#39;PRI_NO_PLL_7372KHzCrystal&#39;, &#39;PRIPLL_8MHzCrystal_16MHzFCY&#39;]:
    buildTargetsSConscript([&#39;reset&#39;],
      env.Clone(MCU=&#39;24FJ64GA002&#39;, CPPDEFINES=&#39;CLOCK_CONFIG=&#39; + clock), &#39;default&#39;, clock)
    buildTargetsSConscript([&#39;reset&#39;],
      env.Clone(MCU=&#39;24FJ64GA102&#39;, CPPDEFINES=&#39;CLOCK_CONFIG=&#39; + clock), &#39;default&#39;, clock)
    buildTargetsSConscript([&#39;reset&#39;],
      env.Clone(MCU=&#39;24F32KA302&#39;, CPPDEFINES=[&#39;CLOCK_CONFIG=&#39; + clock, &#39;HARDWARE_PLATFORM=HARDMAPPED_UART&#39;]), &#39;harmappedUART&#39;, clock)
for clock in [&#39;SIM_CLOCK&#39;, &#39;PRI_NO_PLL_7372KHzCrystal&#39;, &#39;FRC_FCY3685KHz&#39;,
  &#39;FRCPLL_FCY40MHz&#39;, &#39;PRIPLL_7372KHzCrystal_40MHzFCY&#39;, &#39;PRIPLL_8MHzCrystal_40MHzFCY&#39;]:
    buildTargetsSConscript([&#39;reset&#39;],
      env.Clone(MCU=&#39;24HJ32GP202&#39;,  CPPDEFINES=&#39;CLOCK_CONFIG=&#39; + clock), &#39;default&#39;, clock)
    buildTargetsSConscript([&#39;reset&#39;],
      env.Clone(MCU=&#39;33FJ128GP802&#39;, CPPDEFINES=&#39;CLOCK_CONFIG=&#39; + clock), &#39;default&#39;, clock)

</pre></div>
</div>
</div>
<div class="section" id="misc-builds">
<h3><a class="toc-backref" href="#id10">Misc builds</a><a class="headerlink" href="#misc-builds" title="Permalink to this headline">¶</a></h3>
<p>Do a no-float build of reset</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsSConscript([&#39;reset&#39;],
  env.Clone(MCU=&#39;24HJ32GP202&#39;,  CPPDEFINES=&#39;_NOFLOAT&#39;), &#39;default&#39;, &#39;nofloat&#39;)

</pre></div>
</div>
</div>
</div>
<div class="section" id="bootloader-builds">
<h2><a class="toc-backref" href="#id11">Bootloader builds</a><a class="headerlink" href="#bootloader-builds" title="Permalink to this headline">¶</a></h2>
<p>Call <a class="reference internal" href="SCons_bootloader.py.html"><em>SCons_bootloader.py - Build the bootloader</em></a> with a specific Environment. It creates a variant build
named <tt class="docutils literal"><span class="pre">default_bootloader</span> <span class="pre">_</span> <span class="pre">MCU</span></tt>.</p>
<div class="highlight-c"><div class="highlight"><pre>
<span class="n">def</span> <span class="n">buildTargetsBootloader</span><span class="p">(</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>The build environment to use. Typically <tt class="docutils literal"><span class="pre">env</span></tt>, though a <tt class="docutils literal"><span class="pre">env.Clone</span></tt>
can be used to configure env.</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  <span class="n">env</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>The MCU to build the bootloader for.</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  <span class="n">mcu</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>The DEFINEd name of the target platform</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  hardware_platform = &#39;DEFAULT_DESIGN&#39;,
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div>The string to use in the target build directory name</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
  hardware_alias = &#39;default&#39;):

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Create an environment for building the bootloader:
1. Define the MCU and the target hardware platform</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
    <span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">Clone</span><span class="p">(</span><span class="n">MCU</span> <span class="o">=</span> <span class="n">mcu</span><span class="p">,</span> <span class="n">HW</span> <span class="o">=</span> <span class="n">hardware_alias</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div><ol class="arabic simple" start="2">
<li>Use the custom bootloader linker script.</li>
</ol>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
    env.Replace(
        LINKERSCRIPT = &#39;--script=bootloader/pic24_dspic33_bootloader.X/lkr/p${MCU}.gld&#39;,
    )
    env.Append(CPPDEFINES = [&#39;BOOTLOADER&#39;, &#39;HARDWARE_PLATFORM=&#39; + hardware_platform])

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Now, invoke a variant build using this environment.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
    SConscript(&#39;SCons_bootloader.py&#39;, exports = &#39;env bin2hex&#39;,
      variant_dir = &#39;build/bootloader_&#39; + hardware_alias + &#39;_&#39; + mcu)

</pre></div>
</div>
<p>Build the bootloader for a variety of common MCUs
that can have UART in the &#8220;default&#8221; location, e.g.
RB10=MCUrx and RB11=MCUtx</p>
<div class="highlight-c"><div class="highlight"><pre>
for mcu in (&#39;24FJ32GA002&#39;,
            &#39;24FJ64GA002&#39;,
            &#39;24FJ32GA102&#39;,
            &#39;24FJ64GA102&#39;,
            &#39;24FJ64GB002&#39;,
            &#39;24FJ64GB004&#39;,

            &#39;24HJ12GP202&#39;,
            &#39;24HJ32GP202&#39;,
            &#39;24HJ64GP502&#39;,
            &#39;24HJ128GP502&#39;,

            &#39;24EP64GP202&#39;,

            &#39;33FJ32GP202&#39;,
            &#39;33FJ128GP802&#39;,

            &#39;33EP128GP502&#39;,
            &#39;33EP128GP504&#39;,
           ):
    buildTargetsBootloader(env, mcu)

</pre></div>
</div>
<p>Build the bootloader for MCUs with a hardmapped UART.</p>
<div class="highlight-c"><div class="highlight"><pre>
for mcu in (&#39;24F32KA302&#39;,):
    buildTargetsBootloader(env, mcu,
               hardware_platform=&#39;HARDMAPPED_UART&#39;,
               hardware_alias=&#39;hardmappedUART&#39;)

</pre></div>
</div>
<p>Build bootloader for MCUs on specific hardware platforms</p>
<div class="highlight-c"><div class="highlight"><pre>
buildTargetsBootloader(env,
               mcu=&#39;33EP128GP504&#39;,
               hardware_platform=&#39;EMBEDDED_C1&#39;,
               hardware_alias=&#39;embeddedC1&#39;)

buildTargetsBootloader(env,
               mcu=&#39;33EP512GP806&#39;,
               hardware_platform=&#39;EMBEDDED_F14&#39;,
               hardware_alias=&#39;embeddedF14&#39;)

buildTargetsBootloader(env,
               mcu=&#39;33EP128GP502&#39;,
               hardware_platform=&#39;MICROSTICK2&#39;,
               hardware_alias=&#39;microstick2&#39;)

</pre></div>
</div>
</div>
<div class="section" id="esos-builds">
<h2><a class="toc-backref" href="#id12">ESOS builds</a><a class="headerlink" href="#esos-builds" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c"><div class="highlight"><pre>
def buildTargetsEsos(env, mcu, hardware_platform = &#39;DEFAULT_DESIGN&#39;, hardware_alias = &#39;default&#39;):
</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Create an environment for building ESOS.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
    env = env.Clone(MCU = mcu)
    env.Append(CPPDEFINES = [&#39;BUILT_ON_ESOS&#39;, &#39;HARDWARE_PLATFORM=&#39; + hardware_platform],
               CPPPATH = [&#39;esos/include&#39;, &#39;esos/include/pic24&#39;])

</pre></div>
</div>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><blockquote>
<div>Now, invoke a variant build using this environment.</div></blockquote>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre>
    SConscript(&#39;SCons_esos.py&#39;, exports = &#39;env bin2hex&#39;,
      variant_dir = &#39;build/esos_&#39; + hardware_alias + &#39;_&#39; + mcu)

</pre></div>
</div>
<p>Build ESOS over a variety of chips
that can have UART in the &#8220;default&#8221; location, e.g.
RB10=MCUrx and RB11=MCUtx</p>
<div class="highlight-c"><div class="highlight"><pre>
for mcu in (
            &#39;24HJ64GP202&#39;,
            &#39;24FJ64GA002&#39;,
            &#39;24HJ128GP502&#39;,
            &#39;24EP64GP202&#39;,
            &#39;33FJ64GP202&#39;,
            &#39;33FJ128GP802&#39;,
            &#39;33EP128GP502&#39;,
            &#39;33EP128GP504&#39;,
           ):
    buildTargetsEsos(env, mcu)

buildTargetsEsos(env, mcu=&#39;33EP128GP504&#39;, hardware_platform=&#39;EMBEDDED_C1&#39;, hardware_alias=&#39;embeddedC1&#39;)
buildTargetsEsos(env, mcu=&#39;33EP512GP806&#39;, hardware_platform=&#39;EMBEDDED_F14&#39;, hardware_alias=&#39;embeddedF14&#39;)
buildTargetsEsos(env, mcu=&#39;33EP128GP502&#39;, hardware_platform=&#39;MICROSTICK2&#39;, hardware_alias=&#39;microstick2&#39;)
</pre></div>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="SCons_bootloader.py.html" title="SCons_bootloader.py - Build the bootloader"
             >next</a> |</li>
        <li class="right" >
          <a href="runscons.bat.html" title="runscons.bat - Run SCons, collecting and filtering warnings"
             >previous</a> |</li>
        <li><a href="contents.html">Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 4-Jun-2013 documentation</a> &raquo;</li>
          <li><a href="utilities.html" >Utilities</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Bryan A. Jones, Robert B. Reese, and J. W. Bruce.
      Last updated on Oct 30, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>